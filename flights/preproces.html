<!DOCTYPE html>
<meta charset="utf-8">
<title>Create a timetable with the traveltime and airport locations for each flight in the database</title>
<body>
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script>
console.warn('Note; this is a slow process (minutes), you are better of using the finished time.csv, it takes a few hours on a i7-5500u')
//series of globals
var airports = [];
var routes = [];
var firstorder = [];
var directflights = {};
var distances = [];
/* London airports:
Lutton: 492, LTN
Hatwick: 502, LGW
City: 503, LCY
Heathrow: 507, LHR
Stansted: 548, STN
*/
var london = [492,502,503,507,548]; 
var londoncenter = {lat:51.5287352,lon:-0.3817734}

/* great circle distance per
http://www.movable-type.co.uk/scripts/latlong.html
*/

Number.prototype.toRadians = function() {
   return this * Math.PI / 180;
}

var ArcTime = function(begin,end) {
    var lat1 = begin.lat;
    var lat2 = end.lat;
    var lon1 = begin.lon;
    var lon2 = end.lon;
    var speed = 600000; //(600km/h)

    var R = 6371000; // metres
    var φ1 = lat1.toRadians();
    var φ2 = lat2.toRadians();
    var Δφ = (lat2-lat1).toRadians();
    var Δλ = (lon2-lon1).toRadians();

    var a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ/2) * Math.sin(Δλ/2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    var d = R * c;
    return d/speed;
}

//read airports.dat and store it in airports
//airport id (ofl), name, city, country, iata/faa, icao, lat, long, altitude, timezone, dst, tz
d3.text("airports.dat", function(text) {
    airports = d3.csv.parseRows(text).map(function(row) {
    //we want 1 london, so all london airports are remapped to the center of london
    if (london.indexOf(parseInt(row[0]))>-1) {
        return {
            airport: -1,
            name: "London Airports",
            iata: "LONDON",
            lat: londoncenter.lat,
            lon: londoncenter.lon,
            height: parseFloat(row[8])
        }
    }
    else {
        return {
            airport: parseInt(row[0]),
            name: row[1],
            iata: row[4],
            lat: parseFloat(row[6]),
            lon: parseFloat(row[7]),
            height: parseFloat(row[8])
        }
    }
  });
});


//read routes.dat, join it with airports and store it in routes
//airline, airline id, source airport (iata), source airport id (ofl), destination airport (iata), destination airport id (ofl), codeshare, stops, equipment
d3.text("routes.dat", function(text) {
    data = d3.csv.parseRows(text).map(function(row) {    
    var rij = {
            source: row[2],
            sourceid: parseInt(row[3]),     
            destination: row[4],
            destinationid: parseInt(row[5])
        }
    //we want 1 london, so all london airports are remapped to the center of london
    if (london.indexOf(parseInt(row[3]))>-1) {
        rij.sourceid = -1;
        rij.source = "LONDON";
    }
    if (london.indexOf(parseInt(row[5]))>-1) {
        rij.destinationid = -1;
        rij.destination = "LONDON";
    }
    return rij;
  });
  routes = data.map(function(d){
    var a = airports.filter(function(e){return e.iata == d.source})
    var t = airports.filter(function(e){return e.iata == d.destination})
    if(a.length >0 &&t.length>0){
        return {
            beginlat: a[0].lat,
            beginlon: a[0].lon,
            endlat: t[0].lat,
            endlon: t[0].lon,
            flighttime: ArcTime(a[0],t[0]),
            source:d.sourceid,
            dest:d.destinationid,
            start:d.source,
            end:d.destination,
            valid: true
        }
     }
     else { //there are some flights with airports that are not on the airports-list, drop them
        return {
            beginlat: null,
            beginlon: null,
            endlat: null,
            endlon: null,
            flighttime: null,
            source:null,
            dest:null,
            start:null,
            end: null,
            valid: false
            }
        }
   });  
  
  //print the CSV on the screen
  d3.select("body").append("div")
  .html(function(d){return d3.csv.format(routes)})
});
</script>
